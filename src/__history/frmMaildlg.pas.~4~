unit frmMaildlg;

interface

uses
  Winapi.Windows, Winapi.Messages, System.SysUtils, System.Variants, System.Classes, Vcl.Graphics,
  Vcl.Controls, Vcl.Forms, Vcl.Dialogs, FWSQLBaseDlgfrm, Data.FMTBcd,
  IdBaseComponent, IdComponent, IdTCPConnection, IdTCPClient,
  IdExplicitTLSClientServerBase, IdMessageClient, IdSMTPBase, IdSMTP,
  Vcl.StdCtrls, Vcl.ComCtrls, Vcl.ExtCtrls, Vcl.Grids, Vcl.Buttons, Data.DB,
  Data.SqlExpr, IdMessage, IdSSLOpenSSL;

type
  TMailDlgframe = class(TFWSQLBaseDialogframe)
    btnSend: TSpeedButton;
    pnlAddress: TPanel;
    StringGrid1: TStringGrid;
    Splitter1: TSplitter;
    pnlContents: TPanel;
    pnlSubject: TPanel;
    lblSubject: TLabel;
    edtSubject: TEdit;
    pnlContentsTitle: TPanel;
    memoContents: TRichEdit;
    IdSMTP1: TIdSMTP;
    IdMessage1: TIdMessage;
    procedure btnSendClick(Sender: TObject);
  private
    { Private declarations }
  public
    { Public declarations }
    mailTo: String;
  end;

var
  MailDlgframe: TMailDlgframe;

implementation
uses frmMain;

{$R *.dfm}

procedure TMailDlgframe.btnSendClick(Sender: TObject);
var
  subject, body: string;
  msg: TIdMessage;
  IdSMTP: TIdSMTP;
  SSL: TIdSSLIOHandlerSocketOpenSSL;
begin
  inherited;
  IdSMTP := TIdSMTP.Create(nil);
  IdSMTP.Port      := Mainframe.g_MailPort;  //OPB25
  IdSMTP.Host      := Mainframe.g_MailHost;
  IdSMTP.Username  := Mainframe.g_MailUserName;
  IdSMTP.Password  := Mainframe.g_MailPassword;

  subject := edtSubject.Text;
  mailTo  := 'a0441338@sophia.jp';

  body    := memoContents.Lines.Text;

  msg := TIdMessage.Create(IdSmtp);
  SSL := TIdSSLIOHandlerSocketOpenSSL.Create;
  try
    SSL.Host := IdSMTP.Host;
    SSL.Port := IdSMTP.Port;
    SSL.Destination := SSL.Host + ':' + IntToStr(SSL.Port);
    IdSMTP.IOHandler := SSL;
    IdSMTP.UseTLS := utUseExplicitTLS;
    IdSmtp.Connect;
    msg.Subject := subject;
    msg.Recipients.EMailAddresses := mailto;
    msg.From.Text := Mainframe.g_MailFrom;
    msg.Body.Text := body;
    msg.ContentType := 'text/plain';
    IdSmtp.Send(msg);
    IdSmtp.Disconnect ;
    ShowMessage('Message Sent');
  finally
    msg.Free;
    SSL.Free;
    IdSMTP.Free;
  end;
end;

end.
