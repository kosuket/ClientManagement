unit frmMain;

interface

uses
  Winapi.Windows, Winapi.Messages, System.SysUtils, System.Variants, System.Classes, Vcl.Graphics,
  Vcl.Controls, Vcl.Forms, Vcl.Dialogs, Vcl.StdCtrls, Data.DBXMySQL, Data.DB,
  Data.SqlExpr, Data.FMTBcd, Vcl.Grids, Vcl.DBGrids, Vcl.DBCGrids, Vcl.ExtCtrls,
  Vcl.DBCtrls, Datasnap.Provider, Datasnap.DBClient, LogInFrm, Vcl.Buttons,
  Vcl.ComCtrls,frmClientSearch,frmAccounting, frmMaster, Vcl.Menus, Vcl.ImgList;

type
  TMainframe = class(TForm)
    SQLQuery1: TSQLQuery;
    DataSource1: TDataSource;
    ClientDataSet1: TClientDataSet;
    DataSetProvider1: TDataSetProvider;
    pnlMenu: TPanel;
    Splitter1: TSplitter;
    pnlMain: TPanel;
    lblPnlTitle: TLabel;
    btnAccounting: TSpeedButton;
    btnMaster: TSpeedButton;
    MainMenu1: TMainMenu;
    mmFile: TMenuItem;
    mmExit: TMenuItem;
    mmEdit: TMenuItem;
    mmMode: TMenuItem;
    pnlMainTitle: TPanel;
    ImageList1: TImageList;
    Image2: TImage;
    Image1: TImage;
    lblCurrentTitle: TLabel;
    pnlClient: TPanel;
    lblClient: TLabel;
    imgClient: TImage;
    procedure SQLConnection1Login(Database: TSQLConnection;
      LoginParams: TStrings);
    procedure btnAccountingClick(Sender: TObject);
    procedure btnMasterClick(Sender: TObject);
    procedure lblClientMouseEnter(Sender: TObject);
    procedure lblClientMouseLeave(Sender: TObject);
    procedure lblClientClick(Sender: TObject);
    procedure lblClientMouseDown(Sender: TObject; Button: TMouseButton;
      Shift: TShiftState; X, Y: Integer);
    procedure lblClientMouseUp(Sender: TObject; Button: TMouseButton;
      Shift: TShiftState; X, Y: Integer);
  private
    { Private declarations }
    procedure cleanPnlMain;
    procedure setCurrentTitle(str: String; int: Integer);
  public
    { Public declarations }
    frmLogIn: TLogInFrame;
    frmClientSearch: TClientSearchframe;
    frmAccountingSearch: TAccountingFrame;
    frmMasterSetting: TMasterFrame;
    SQLConnection1: TSQLConnection;
    g_Username: String;
    g_Password: String;
    g_Database: String;
    g_SchemaName: String;
    g_HostName: String;
    constructor Create(AOwner: TComponent) ; override;
  end;

var
  Mainframe: TMainframe;

implementation

{$R *.dfm}

procedure TMainframe.btnAccountingClick(Sender: TObject);
begin
  cleanPnlMain;
  frmAccountingSearch.pnlBase.Visible := True;
  setCurrentTitle(btnAccounting.Caption,1);
end;

procedure TMainframe.btnMasterClick(Sender: TObject);
begin
  cleanPnlMain;
  frmMasterSetting.pnlBase.Visible := True;
  setCurrentTitle(btnMaster.Caption,2);
end;

procedure TMainframe.cleanPnlMain;
begin
  frmClientSearch.pnlBase.Visible := False;
  frmAccountingSearch.pnlBase.Visible := False;
  frmMasterSetting.pnlBase.Visible := False;
end;

constructor TMainframe.Create(AOwner: TComponent);
begin
  frmLogIn := TLogInFrame.Create(Self);
  If frmLogIn.ShowModal = 1 then begin
  if not SQLConnection1.Connected then Application.Terminate;
  inherited;
  SQLQuery1.SQLConnection := SQLConnection1;
  end else begin
    Application.Terminate;
  end;
  //ClientSearch
  frmClientSearch := TClientSearchframe.Create(self);
  frmClientSearch.sqlqSchoolName.SQLConnection := SQLConnection1;
  frmClientSearch.SQLQuery1 := SQLQuery1;
  frmClientSearch.ClientDataSet1 := ClientDataSet1;
  frmClientSearch.DBGrid1.DataSource := DataSource1;
  frmClientSearch.pnlBase.Parent := pnlMain;
  frmClientSearch.Initialize;
  frmClientSearch.pnlBase.Visible := False;

  //AccountingSearch
  frmAccountingSearch := TAccountingFrame.Create(Self);
  frmAccountingSearch.pnlBase.Parent := pnlMain;
  frmAccountingSearch.pnlBase.Visible := False;

  //MasterSetting
  frmMasterSetting := TMasterFrame.Create(Self);
  frmMasterSetting.pnlBase.Parent := pnlMain;
  frmMasterSetting.pnlBase.Visible := False;
  //LastProc
  frmClientSearch.pnlBase.Visible := True;

end;

procedure TMainframe.lblClientClick(Sender: TObject);
begin
  cleanPnlMain;
  frmClientSearch.pnlBase.Visible := True;
  setCurrentTitle(lblClient.Caption,0);
end;

procedure TMainframe.lblClientMouseDown(Sender: TObject; Button: TMouseButton;
  Shift: TShiftState; X, Y: Integer);
begin
  pnlMenu.BevelOuter := bvLowered;
end;

procedure TMainframe.lblClientMouseEnter(Sender: TObject);
begin
  lblClient.Color := $00CBC2FE;
  pnlClient.Color := $00CBC2FE;
  imgClient.Repaint;
  lblClient.Font.Color := clWindow;
end;

procedure TMainframe.lblClientMouseLeave(Sender: TObject);
begin
  lblClient.Color := clWindow;
  lblClient.Font.Color := clBlack;
  pnlClient.BevelOuter := bvNone;
end;

procedure TMainframe.lblClientMouseUp(Sender: TObject; Button: TMouseButton;
  Shift: TShiftState; X, Y: Integer);
begin
  pnlClient.BevelOuter := bvNone;
end;

procedure TMainframe.setCurrentTitle(str: String; int: Integer);
begin
  lblCurrentTitle.Caption := str;
  Image1.Picture := nil;
  ImageList1.GetBitmap(int,Image1.Picture.Bitmap);
  Image1.Repaint;
end;

procedure TMainframe.SQLConnection1Login(Database: TSQLConnection;
  LoginParams: TStrings);
var strList: TStrings;
    i: Integer;
begin
  //ソースの内部実装がわからないためLoginParamsとSQLConnection1.Paramsの両方を変更する
  strList := TStringList.Create;
  strList.Add('Password=' + g_Password);
  strList.Add('User_Name=' + g_UserName);
  strList.Add('Database=edogijuku_db');
  LoginParams := strList;
  for i := 0 to SQLConnection1.Params.Count - 1 do begin
    if LowerCase(Copy(SQLConnection1.Params[i],1,8))='password' then begin
      SQLConnection1.Params[i] := 'Password=' + g_Password;
    end;
    if LowerCase(Copy(SQLConnection1.Params[i],1,9))='user_name' then begin
      SQLConnection1.Params[i] := 'User_Name=' + g_UserName;
    end;
  end;
  inherited;
end;

end.
