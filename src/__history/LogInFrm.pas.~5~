unit LogInFrm;

interface

uses
  Winapi.Windows, Winapi.Messages, System.SysUtils, System.Variants, System.Classes, Vcl.Graphics,
  Vcl.Controls, Vcl.Forms, Vcl.Dialogs, Vcl.Mask, Vcl.StdCtrls, Vcl.Buttons,
  Data.DBXMySQL, Data.DB, Data.SqlExpr;

type
  TLogInFrame = class(TForm)
    edtUserName: TEdit;
    edtPassword: TMaskEdit;
    btnOK: TSpeedButton;
    btnCancel: TSpeedButton;
    lblUser: TLabel;
    lblPassword: TLabel;
    lblLogInTitle: TLabel;
    SQLConnection1: TSQLConnection;
    procedure btnCancelClick(Sender: TObject);
    procedure btnOKClick(Sender: TObject);
    procedure SQLConnection1Login(Database: TSQLConnection;
      LoginParams: TStrings);
    procedure edtPasswordKeyPress(Sender: TObject; var Key: Char);
  private
    { Private declarations }
  public
    { Public declarations }
  end;

var
  LogInFrame: TLogInFrame;

implementation
uses frmMain;
{$R *.dfm}

procedure TLogInFrame.btnOKClick(Sender: TObject);
var strList: TStrings;
begin
  strList := TStringList.Create;
  Mainframe.g_Username := edtUserName.Text;
  Mainframe.g_Password := edtPassword.Text;
  SQLConnection1Login(SQLConnection1,strList);
  try
  SQLConnection1.Open;
  Mainframe.SQLConnection1 := SQLConnection1;
  ModalResult := mrOk;
  except
    ShowMessage('Log In Failed');
    ModalResult := mrNone;
  end;
end;

procedure TLogInFrame.edtPasswordKeyPress(Sender: TObject; var Key: Char);
begin
  if Ord(Key) = VK_RETURN then btnOKClick(Self);
end;

procedure TLogInFrame.SQLConnection1Login(Database: TSQLConnection;
  LoginParams: TStrings);
var strList: TStrings;
    i: Integer;
begin
  //ソースの内部実装がわからないためLoginParamsとSQLConnection1.Paramsの両方を変更する
  strList := TStringList.Create;
  strList.Add('Password=' + edtPassword.Text);
  strList.Add('User_Name=' + edtUserName.Text);
  strList.Add('Database=edogijuku_db');
  LoginParams := strList;
  for i := 0 to SQLConnection1.Params.Count - 1 do begin
    if LowerCase(Copy(SQLConnection1.Params[i],1,8))='password' then begin
      SQLConnection1.Params[i] := 'Password=' + edtPassword.Text;
    end;
    if LowerCase(Copy(SQLConnection1.Params[i],1,9))='user_name' then begin
      SQLConnection1.Params[i] := 'User_Name=' + edtUserName.Text;
    end;
  end;
  inherited;
end;

procedure TLogInFrame.btnCancelClick(Sender: TObject);
begin
  ModalResult := mrCancel;
end;

end.
